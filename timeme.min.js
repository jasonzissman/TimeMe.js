(function(){var e,t;e=this,t=function(){var o={startStopTimes:{},idleTimeoutMs:3e4,currentIdleTimeMs:0,checkStateRateMs:250,active:!1,idle:!1,currentPageName:"default-page-name",timeElapsedCallbacks:[],userLeftCallbacks:[],userReturnCallbacks:[],trackTimeOnElement:function(e){var t=document.getElementById(e);t&&(t.addEventListener("mouseover",function(){o.startTimer(e)}),t.addEventListener("mousemove",function(){o.startTimer(e)}),t.addEventListener("mouseleave",function(){o.stopTimer(e)}),t.addEventListener("keypress",function(){o.startTimer(e)}),t.addEventListener("focus",function(){o.startTimer(e)}))},getTimeOnElementInSeconds:function(e){var t=o.getTimeOnPageInSeconds(e);return t||0},startTimer:function(e){if(e||(e=o.currentPageName),void 0===o.startStopTimes[e])o.startStopTimes[e]=[];else{var t=o.startStopTimes[e],n=t[t.length-1];if(void 0!==n&&void 0===n.stopTime)return}o.startStopTimes[e].push({startTime:new Date,stopTime:void 0}),o.active=!0},stopAllTimers:function(){for(var e=Object.keys(o.startStopTimes),t=0;t<e.length;t++)o.stopTimer(e[t])},stopTimer:function(e){e||(e=o.currentPageName);var t=o.startStopTimes[e];void 0!==t&&0!==t.length&&(void 0===t[t.length-1].stopTime&&(t[t.length-1].stopTime=new Date),o.active=!1)},getTimeOnCurrentPageInSeconds:function(){return o.getTimeOnPageInSeconds(o.currentPageName)},getTimeOnPageInSeconds:function(e){return void 0===o.getTimeOnPageInMilliseconds(e)?void 0:o.getTimeOnPageInMilliseconds(e)/1e3},getTimeOnCurrentPageInMilliseconds:function(){return o.getTimeOnPageInMilliseconds(o.currentPageName)},getTimeOnPageInMilliseconds:function(e){var t=o.startStopTimes[e];if(void 0!==t){for(var n=0,i=0;i<t.length;i++){var s=t[i].startTime,r=t[i].stopTime;void 0===r&&(r=new Date),n+=r-s}return Number(n)}},getTimeOnAllPagesInSeconds:function(){for(var e=[],t=Object.keys(o.startStopTimes),n=0;n<t.length;n++){var i=t[n],s=o.getTimeOnPageInSeconds(i);e.push({pageName:i,timeOnPage:s})}return e},setIdleDurationInSeconds:function(e){var t=parseFloat(e);if(!1!==isNaN(t))throw{name:"InvalidDurationException",message:"An invalid duration time ("+e+") was provided."};return o.idleTimeoutMs=1e3*e,this},setCurrentPageName:function(e){return o.currentPageName=e,this},resetRecordedPageTime:function(e){delete o.startStopTimes[e]},resetAllRecordedPageTimes:function(){for(var e=Object.keys(o.startStopTimes),t=0;t<e.length;t++)o.resetRecordedPageTime(e[t])},resetIdleCountdown:function(){o.idle&&o.triggerUserHasReturned(),o.idle=!1,o.currentIdleTimeMs=0},callWhenUserLeaves:function(e,t){this.userLeftCallbacks.push({callback:e,numberOfTimesToInvoke:t})},callWhenUserReturns:function(e,t){this.userReturnCallbacks.push({callback:e,numberOfTimesToInvoke:t})},triggerUserHasReturned:function(){if(!o.active)for(var e=0;e<this.userReturnCallbacks.length;e++){var t=this.userReturnCallbacks[e],n=t.numberOfTimesToInvoke;(isNaN(n)||void 0===n||0<n)&&(t.numberOfTimesToInvoke-=1,t.callback())}o.startTimer()},triggerUserHasLeftPage:function(){if(o.active)for(var e=0;e<this.userLeftCallbacks.length;e++){var t=this.userLeftCallbacks[e],n=t.numberOfTimesToInvoke;(isNaN(n)||void 0===n||0<n)&&(t.numberOfTimesToInvoke-=1,t.callback())}o.stopAllTimers()},callAfterTimeElapsedInSeconds:function(e,t){o.timeElapsedCallbacks.push({timeInSeconds:e,callback:t,pending:!0})},checkState:function(){for(var e=0;e<o.timeElapsedCallbacks.length;e++)o.timeElapsedCallbacks[e].pending&&o.getTimeOnCurrentPageInSeconds()>o.timeElapsedCallbacks[e].timeInSeconds&&(o.timeElapsedCallbacks[e].callback(),o.timeElapsedCallbacks[e].pending=!1);!1===o.idle&&o.currentIdleTimeMs>o.idleTimeoutMs?(o.idle=!0,o.triggerUserHasLeftPage()):o.currentIdleTimeMs+=o.checkStateRateMs},visibilityChangeHandler:function(){document[o.hiddenPropName]?o.triggerUserHasLeftPage():o.triggerUserHasReturned()},visibilityChangeEventName:void 0,hiddenPropName:void 0,listenForVisibilityEvents:function(){void 0!==document.hidden?(o.hiddenPropName="hidden",o.visibilityChangeEventName="visibilitychange"):void 0!==document.mozHidden?(o.hiddenPropName="mozHidden",o.visibilityChangeEventName="mozvisibilitychange"):void 0!==document.msHidden?(o.hiddenPropName="msHidden",o.visibilityChangeEventName="msvisibilitychange"):void 0!==document.webkitHidden&&(o.hiddenPropName="webkitHidden",o.visibilityChangeEventName="webkitvisibilitychange"),document.addEventListener(o.visibilityChangeEventName,o.visibilityChangeHandler,!1),window.addEventListener("blur",o.triggerUserHasLeftPage),window.addEventListener("focus",o.triggerUserHasReturned),document.addEventListener("mousemove",o.resetIdleCountdown),document.addEventListener("keyup",o.resetIdleCountdown),document.addEventListener("touchstart",o.resetIdleCountdown),window.addEventListener("scroll",o.resetIdleCountdown),o.checkStateIntervalId=setInterval(function(){o.checkState()},o.checkStateRateMs)},websocket:void 0,websocketHost:void 0,setUpWebsocket:function(t){if(window.WebSocket&&t){var e=t.websocketHost;try{o.websocket=new WebSocket(e),window.onbeforeunload=function(e){o.sendCurrentTime(t.appId)},o.websocket.onopen=function(){o.sendInitWsRequest(t.appId)},o.websocket.onerror=function(e){console&&console.log("Error occurred in websocket connection: "+e)},o.websocket.onmessage=function(e){console&&console.log(e.data)}}catch(e){console&&console.error("Failed to connect to websocket host.  Error:"+e)}}return this},websocketSend:function(e){o.websocket.send(JSON.stringify(e))},sendCurrentTime:function(e){var t={type:"INSERT_TIME",appId:e,timeOnPageMs:o.getTimeOnCurrentPageInMilliseconds(),pageName:o.currentPageName};o.websocketSend(t)},sendInitWsRequest:function(e){var t={type:"INIT",appId:e};o.websocketSend(t)},initialize:function(e){var t=o.idleTimeoutMs||30,n=o.currentPageName||"default-page-name",i=void 0;e&&(t=e.idleTimeoutInSeconds||t,n=e.currentPageName||n,i=e.websocketOptions),o.setIdleDurationInSeconds(t).setCurrentPageName(n).setUpWebsocket(i).listenForVisibilityEvents(),o.startTimer()},destroy:function(){o.checkStateIntervalId&&clearInterval(o.checkStateIntervalId),document.removeEventListener("mousemove",o.resetIdleCountdown),document.removeEventListener("keyup",o.resetIdleCountdown),document.removeEventListener("touchstart",o.resetIdleCountdown),document.removeEventListener(o.visibilityChangeEventName,o.visibilityChangeHandler),window.removeEventListener("scroll",o.resetIdleCountdown),window.removeEventListener("blur",o.triggerUserHasLeftPage),window.removeEventListener("focus",o.triggerUserHasReturned)}};return o},"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],function(){return e.TimeMe=t()}):e.TimeMe=t()}).call(this);